#Generated by Kickstart Configurator
#platform=AMD64 or Intel EM64T

#System language
lang en_US
#Language modules to install
langsupport en_US
#System keyboard
keyboard us
#System mouse
mouse
#System timezone
timezone America/New_York
#Root password
rootpw --disabled
#Initial user
user imageadmin --fullname "" --password imageadmin
#Use text mode install
text
#Install OS instead of upgrade
install
#Use CDROM installation media
cdrom
#System bootloader configuration
bootloader --location=mbr
#Clear the Master Boot Record
zerombr yes


#Partition clearing information
clearpart --all --initlabel
#Disk partitioning done with preseed


#System authorization information
auth --useshadow
#Firewall configuration
firewall --disabled
#Do not configure the X Window System
skipx

%packages
@ ubuntu-server
openssh-server

%post
# Can't do this directly since the user doesn't exist yet(kickstart post is called early in the finish process)
# We'll run this with a preseed late command
cat <<SCRIPTCOPY >/tmp/setupkeys.sh
#!/bin/sh
# Copy our public ssh key
mkdir --mode=700 /home/imageadmin/.ssh
cat <<EOF > /home/imageadmin/.ssh/authorized_keys
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDDP9Ps2OpMpTQcTXaaf+E7R5Sadth2ha/bv9HwNSPN7lEuqxihiDfoG9YIK66T/6X1z+jLzhZ9T9ptyLTuWyIca2JqAwJmvRQMUYPZtSIqqfhdTvdDBIe7i6WD2qKi39Q74DlVCcYntUVXQYc+DH64MCfCO79KiB7Wp+2uKB9E6snok7zUzVIR1JHoDArOg/HLL2UJCO5RiMo5N9Ea9ztCRwXWa+BgU9yydF4mSaJzLSu2lXrsEwqhtNT3947XPs6VQis2mWAIHBH2CPlKbSgWYtqVMwo1EcghfEUomMAkfqVV3BsSUt8N5Kqs5/A4R+lwMkBlUdnykHT9VUdSXgCr ICPC Environment Key
EOF
chmod 600 /home/imageadmin/.ssh/authorized_keys
chown -R imageadmin:imageadmin /home/imageadmin/.ssh
rm /tmp/setupkeys.sh
SCRIPTCOPY

chmod 755 /tmp/setupkeys.sh

# Enable passwordless sudo
sed -i -e 's/%sudo	ALL=(ALL:ALL) ALL/%sudo	ALL=NOPASSWD:ALL/g' /etc/sudoers

# Don't reserve space for root
tune2fs -r 0 /dev/sda2

# This fixes a weird issue with qemu not wanting to boot the system unless you
# hold down shift, and manually pick the os to boot.

# Disable graphical grub console
sed -i -e 's/#\(GRUB_TERMINAL.*\)/\1/' /etc/default/grub

# Disable quiet/splash boot options
sed -i -e 's/quiet splash//' /etc/default/grub

# Finally update grub so the changes stick after reboot
update-grub
